<!DOCTYPE html>
<html lang="en">
<head>
  <title>CoTex Preview</title>
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@2.6.347/build/pdf.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    
    function loadPdf(url,viewer) {      
      return pdfjsLib.getDocument(url).promise.then(function(pdf) { 
        const nContainers = document.getElementsByClassName('page-container');

        for(let i = pdf.numPage + 1; i <= nContainers; i++) {
          document.getElementById('page-' + i).remove();
        }
        
        for(let i = 1; i <= pdf.numPages; i++) {
          let id = 'page-' + i;
          let container = document.getElementById(id); 
          if(!container) {
            container = document.createElement("div");
            container.setAttribute('id', id);    
            container.className = 'page-container';
            viewer.appendChild(container);
          }
          renderPage(pdf,container,i);
        }
      });
    }
    
    async function renderPage(pdf,container,pageNum) {
      const page = await pdf.getPage(pageNum);
      let viewport = page.getViewport({ scale: 1, });
      const desiredWidth = viewer.offsetWidth * 1.2;
      const scale = desiredWidth / viewport.width;
      var scaledViewport = page.getViewport({ scale: scale, });      
      const canvas = document.createElement("canvas");    
      canvas.className = 'pdf-page';         
      container.innerHTML = '';
      container.appendChild(canvas);
      const context = canvas.getContext('2d');
      canvas.height = scaledViewport.height;
      canvas.width = scaledViewport.width;
      
      return page.render({canvasContext: context, viewport: scaledViewport});
    }
    </script>
  <style>
    .pdf-page {
      display: block;
      margin: auto;
      margin-bottom: 10px;
      width: 75%;
    }

    .pdf-container {
      width: 100%;
    }
  </style>
</head>
<body style="margin: 0;">
  <div id="pdf-container" style="overflow-y: scroll;max-height: 95vh; background: grey;"></div>
</body>
<script>
  var socket = io();
  const viewer = document.getElementById('pdf-container');
  const url = 'http://localhost:5000/projects/1/output';
  
  
  socket.on('compile', function(msg) {
    const height = viewer.scrollTop;
    
    loadPdf(url,viewer).then(() => {
      
    });
  });
  
  loadPdf(url,viewer);
</script>
</html>